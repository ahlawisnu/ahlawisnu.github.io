
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Miku Prompt Builder ULTRA</title>

<style>
body.dark{
--bg:#070b14;--surface:#0f1624;--card:#172036;
--primary:#3df2e6;--secondary:#8fd7ff;
--value:#2ecc71;--array:#f1c40f;--object:#9b59b6;
--danger:#ff5b7c;--text:#eaf6ff;
}
body.light{
--bg:#f5f7ff;--surface:#fff;--card:#eef1ff;
--primary:#00bcd4;--secondary:#3f51b5;
--value:#2e7d32;--array:#f9a825;--object:#6a1b9a;
--danger:#d32f2f;--text:#111;
}
body.purple{
--bg:#0c0014;--surface:#19002b;--card:#260040;
--primary:#ff4dff;--secondary:#8fd7ff;
--value:#00e676;--array:#ffea00;--object:#b388ff;
--danger:#ff1744;--text:#f5e6ff;
}

body{
margin:0;padding:16px;
background:var(--bg);
color:var(--text);
font-family:system-ui;
transition:.3s;
}

h1{text-align:center;color:var(--primary);}
.app{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
@media(max-width:900px){.app{grid-template-columns:1fr;}}

.panel{background:var(--surface);padding:14px;border-radius:16px;}

.toolbar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}

button{
background:linear-gradient(135deg,var(--primary),var(--secondary));
border:none;padding:8px 14px;border-radius:999px;
font-weight:600;cursor:pointer;
}

input,select{
background:var(--card);
border:1px solid #555;
border-radius:8px;
padding:6px;
color:var(--text);
}

input.error{border:2px solid var(--danger);}
.row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px;}

.child{
padding:8px;border-radius:10px;
margin-left:16px;margin-top:6px;
border-left:4px solid var(--primary);
}
.child.value{border-color:var(--value);}
.child.array{border-color:var(--array);}
.child.object{border-color:var(--object);}

textarea,pre{
width:100%;height:180px;
background:black;color:#00ffd5;
border-radius:10px;padding:10px;
font-family:monospace;
}

.highlight{outline:3px solid yellow;}
</style>
</head>

<body class="dark">

<h1>üé§ Miku Prompt Builder ULTRA</h1>

<div class="toolbar">
<button onclick="undo()">‚è™ Undo</button>
<button onclick="redo()">‚è© Redo</button>

<select onchange="setTheme(this.value)">
<option value="dark">Miku Dark</option>
<option value="light">Light Neon</option>
<option value="purple">Cyber Purple</option>
</select>

<input id="search" placeholder="Search key..." oninput="searchNode(this.value)">
</div>

<div class="app">

<div class="panel">
<h3>Outer</h3>
<div id="outer"></div>
<button onclick="addOuter()">‚ûï Outer</button>

<h3>Inner</h3>
<div id="inner"></div>
<button onclick="addInner(inner)">‚ûï Field</button>
</div>

<div class="panel">
<div class="toolbar">
<button onclick="copyOut()">Copy</button>
<button onclick="exportFile('txt')">TXT</button>
<button onclick="exportFile('yaml')">YAML</button>
<button onclick="exportFile('xml')">XML</button>
</div>

<textarea id="output"></textarea>
<pre id="tree"></pre>
</div>

</div>

<script>
const outer=document.getElementById("outer");
const inner=document.getElementById("inner");
const output=document.getElementById("output");
const tree=document.getElementById("tree");

/* ===== HISTORY ===== */
let history=[],future=[];
function snapshot(){
history.push(JSON.stringify(saveState()));
future=[];
}
function undo(){
if(!history.length)return;
future.push(JSON.stringify(saveState()));
loadState(JSON.parse(history.pop()));
}
function redo(){
if(!future.length)return;
history.push(JSON.stringify(saveState()));
loadState(JSON.parse(future.pop()));
}

/* ===== OUTER ===== */
function addOuter(k="",v=""){
const r=document.createElement("div");
r.className="row";
r.innerHTML=`
<input class="ok" value="${k}">
<input class="ov" value="${v}">
<button onclick="this.parentElement.remove();update()">‚úñ</button>`;
outer.appendChild(r);
snapshot();update();
}
addOuter("action","image_to_text");

/* ===== INNER ===== */
function createInner(){
const d=document.createElement("div");
d.className="child value";
d.innerHTML=`
<div class="row">
<input class="ik">
<select class="it" onchange="setType(this)">
<option value="value">value</option>
<option value="array">array</option>
<option value="object">object</option>
</select>
<input class="iv">
<button onclick="addInner(this.parentElement.nextElementSibling)">Ôºã</button>
<button onclick="this.closest('.child').remove();update()">‚úñ</button>
</div>
<div></div>`;
return d;
}
function addInner(p){
p.appendChild(createInner());
snapshot();update();
}
function setType(s){
s.closest(".child").className="child "+s.value;
update();
}

/* ===== BUILD ===== */
function buildInner(p){
let o={};
p.querySelectorAll(":scope>.child").forEach(n=>{
const k=n.querySelector(".ik");
const v=n.querySelector(".iv");
k.classList.toggle("error",!k.value);
const t=n.querySelector(".it").value;
if(!k.value)return;
if(t==="value")o[k.value]=v.value;
if(t==="array")o[k.value]=v.value.split(",").map(x=>x.trim());
if(t==="object")o[k.value]=buildInner(n.children[1]);
});
return o;
}

/* ===== TREE TEXT ===== */
function treeText(o,i=""){
let t="";
for(const k in o){
if(typeof o[k]==="object"&&!Array.isArray(o[k])){
t+=`${i}${k}\n`+treeText(o[k],i+"  ");
}else{
t+=`${i}${k}: ${o[k]}\n`;
}}
return t;
}

/* ===== UPDATE ===== */
function update(){
let outerObj={};
document.querySelectorAll(".ok").forEach((k,i)=>{
const v=document.querySelectorAll(".ov")[i].value;
if(k.value) outerObj[k.value]=v;
});
const innerObj=buildInner(inner);
const esc=JSON.stringify(innerObj).replace(/"/g,'\"');
outerObj["action_input"]=`{ ${esc.slice(1,-1)} }`;
output.value=JSON.stringify(outerObj,null,2);
tree.textContent=treeText(innerObj);
localStorage.setItem("miku_state",JSON.stringify(saveState()));
}

/* ===== STATE ===== */
function saveState(){
return{
outer:outer.innerHTML,
inner:inner.innerHTML,
theme:document.body.className
};
}
function loadState(s){
outer.innerHTML=s.outer;
inner.innerHTML=s.inner;
setTheme(s.theme);
update();
}

/* AUTO LOAD */
const saved=localStorage.getItem("miku_state");
if(saved) loadState(JSON.parse(saved));

document.addEventListener("input",update);

/* ===== SEARCH ===== */
function searchNode(q){
document.querySelectorAll(".child").forEach(n=>{
const k=n.querySelector(".ik").value.toLowerCase();
n.classList.toggle("highlight",q && k.includes(q.toLowerCase()));
});
}

/* ===== THEME ===== */
function setTheme(t){
document.body.className=t;
}

/* ===== EXPORT ===== */
function copyOut(){navigator.clipboard.writeText(output.value);}
function exportFile(type){
let data=output.value;
if(type==="yaml"){
const o=JSON.parse(data);
data=Object.entries(o).map(e=>`${e[0]}: ${e[1]}`).join("\n");
}
if(type==="xml"){
const o=JSON.parse(data);
data="<root>\n"+Object.entries(o).map(e=>`<${e[0]}>${e[1]}</${e[0]}>`).join("\n")+"\n</root>";
}
const b=new Blob([data],{type:"text/plain"});
const a=document.createElement("a");
a.href=URL.createObjectURL(b);
a.download="prompt."+type;
a.click();
}
</script>

</body>
</html>
